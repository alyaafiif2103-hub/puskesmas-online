<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Riwayat Antrian - Puskesmas</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark bg-primary">
  <div class="container">
    <a class="navbar-brand" href="index.html">Puskesmas Online</a>
  </div>
</nav>

<main class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h3 class="fw-bold">Riwayat Antrian</h3>
    <div>
      <button class="btn btn-outline-secondary me-2" id="btnExport">Export CSV</button>
      <button class="btn btn-outline-danger me-2" id="btnClearAll">Hapus Semua</button>
      <button class="btn btn-outline-success me-2" id="btnNext">Panggil Antrian Berikutnya</button>
      <a href="daftar_antrian.html" class="btn btn-outline-primary">Daftar Antrian Baru</a>
      <a href="index.html" class="btn btn-outline-success">Kembali</a>
    </div>
  </div>

  <div class="table-responsive">
    <table class="table table-striped table-bordered" id="tblRiwayat">
      <thead class="table-primary">
        <tr>
          <th>No</th>
          <th>Nomor Antrian</th>
          <th>Nama</th>
          <th>JK</th>
          <th>Layanan</th>
          <th>Tanggal</th>
          <th>Waktu Daftar</th>
          <th>Status</th>
          <th>Aksi</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</main>

<script>
// Ubah angka menjadi kata bahasa Indonesia (1-99)
function numberToWords(num) {
  const satuan = ["","satu","dua","tiga","empat","lima","enam","tujuh","delapan","sembilan"];
  if (num < 10) return satuan[num];
  if (num >= 10 && num < 20) {
    return num === 10 ? "sepuluh" : num === 11 ? "sebelas" : satuan[num-10] + " belas";
  }
  if (num >= 20 && num < 100) {
    let puluhan = Math.floor(num / 10);
    let sisa = num % 10;
    return satuan[puluhan] + " puluh" + (sisa ? " " + satuan[sisa] : "");
  }
  return num; 
}

// Render Riwayat
function renderRiwayat() {
  const table = document.querySelector('#tblRiwayat tbody');
  if (!table) return;

  const entries = JSON.parse(localStorage.getItem('puskesmas_antrian') || '[]')
                     .sort((a,b) => new Date(a.waktuDaftar) - new Date(b.waktuDaftar));
  table.innerHTML = '';

  entries.forEach((it, idx) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${idx + 1}</td>
      <td>${it.noAntrian}</td>
      <td>${it.nama}</td>
      <td>${it.jk || '-'}</td>
      <td>${it.layanan}</td>
      <td>${it.tanggal}</td>
      <td>${new Date(it.waktuDaftar).toLocaleString()}</td>
      <td>
        <span class="badge ${it.status === 'Selesai' ? 'bg-success' : it.status === 'Dipanggil' ? 'bg-info' : 'bg-warning'}">
          ${it.status}
        </span>
      </td>
      <td>
        ${it.status !== 'Selesai' ? '<button class="btn btn-sm btn-success btn-selesai">Selesai</button>' : ''}
      </td>
    `;

    const btnSelesai = tr.querySelector('.btn-selesai');
    if (btnSelesai) {
      btnSelesai.addEventListener('click', () => {
        it.status = 'Selesai';
        localStorage.setItem('puskesmas_antrian', JSON.stringify(entries));
        renderRiwayat();
      });
    }

    table.appendChild(tr);
  });
}

// Export CSV
function exportCSV() {
  const entries = JSON.parse(localStorage.getItem('puskesmas_antrian') || '[]');
  if (!entries.length) { alert('Tidak ada data untuk diexport.'); return; }

  const header = ['No','NoAntrian','Nama','JK','Layanan','Tanggal','WaktuDaftar','Status'];
  const rows = entries.map((it,i) => [i+1,it.noAntrian,it.nama,it.jk,it.layanan,it.tanggal,it.waktuDaftar,it.status]);
  const csv = [header,...rows].map(r => r.map(c => `"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n');

  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'riwayat_antrian.csv';
  a.click();
  URL.revokeObjectURL(url);
}

// Panggil Antrian Berikutnya dengan suara cewek formal, pelan
function nextQueue() {
  const entries = JSON.parse(localStorage.getItem('puskesmas_antrian') || '[]');
  const next = entries.find(e => e.status === 'Menunggu');
  if (!next) { 
    alert('Tidak ada antrian menunggu.'); 
    return; 
  }
  
  next.status = 'Dipanggil';
  localStorage.setItem('puskesmas_antrian', JSON.stringify(entries));
  renderRiwayat();

  if ('speechSynthesis' in window) {
    let layanan = next.layanan || 'umum';
    let nomorKata = numberToWords(parseInt(next.noAntrian));
    let text = `Nomor antrian ${nomorKata}, pasien untuk layanan ${layanan}, mohon segera menuju loket. Terima kasih.`;

    const msg = new SpeechSynthesisUtterance(text);
    msg.lang = 'id-ID';
    msg.rate = 0.7;   // lambat
    msg.pitch = 1.2;  // lebih tinggi, terdengar cewek

    // Pilih voice cewek Indonesia jika ada
    const voices = window.speechSynthesis.getVoices();
    const femaleVoice = voices.find(v => v.lang.startsWith('id') && /female|woman|girl/i.test(v.name));
    if(femaleVoice) {
      msg.voice = femaleVoice;
    }

    window.speechSynthesis.speak(msg);
  } else {
    console.warn('Browser tidak mendukung speech synthesis.');
  }
}

// Event listeners
document.addEventListener('DOMContentLoaded', renderRiwayat);
document.getElementById('btnExport').addEventListener('click', exportCSV);
document.getElementById('btnClearAll').addEventListener('click', () => {
  if (!confirm('Hapus semua riwayat antrian?')) return;
  localStorage.removeItem('puskesmas_antrian');
  renderRiwayat();
});
document.getElementById('btnNext').addEventListener('click', nextQueue);
</script>
</body>
</html>
